# AI-Powered Game Implementation

## Overview

Successfully implemented an AI-powered prompt injection game using:
- **LangGraph** for workflow orchestration
- **Kimi K2 via Groq** for intelligent evaluation and responses
- **Postgres checkpointer** for conversation state persistence
- **Structured output** with JSON schema validation
- **Secure phone number handling** via Runtime context

## Architecture

### Following Puffin Project Pattern

The implementation follows the exact architecture from `jem_mobile/whatsapp_chatbot`:

1. **StateGraph with context_schema**: `StateGraph(AIGameState, context_schema=GameContext)`
2. **Postgres Checkpointer**: `PostgresSaver` for conversation persistence
3. **Static Runtime Context**: Phone numbers in `Runtime[GameContext]` (NOT accessible to LLM)
4. **Structured Output**: Groq's native `response_format` with JSON schema
5. **END Node Pattern**: Dedicated `whatsapp_sender_node` for message delivery

### Directory Structure

```
app/ai_game/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ state.py                    # AIGameState (dynamic conversation state)
‚îú‚îÄ‚îÄ context.py                  # GameContext (static runtime context)
‚îú‚îÄ‚îÄ prompts.py                  # Kimi K2 system prompts
‚îú‚îÄ‚îÄ workflow.py                 # LangGraph StateGraph orchestration
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ groq_client.py         # Kimi K2 with structured output
‚îî‚îÄ‚îÄ nodes/
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ evaluation_node.py     # Kimi evaluates player message
    ‚îú‚îÄ‚îÄ response_node.py       # Kimi generates response
    ‚îú‚îÄ‚îÄ update_state_node.py   # Updates Redis state
    ‚îî‚îÄ‚îÄ sender_node.py         # WhatsApp END node
```

### Workflow Flow

```
START ‚Üí evaluate_message ‚Üí generate_response ‚Üí update_state ‚Üí whatsapp_sender ‚Üí END
```

1. **evaluate_message**: Kimi K2 judges if message beats level defenses
2. **generate_response**: Kimi K2 generates contextual response
3. **update_state**: Updates Redis with game progress
4. **whatsapp_sender**: Sends message via WhatsApp (END node)

## Key Features

### Security
- ‚úÖ **Phone numbers NEVER exposed to LLM**
  - Stored in `GameContext` (static runtime context)
  - Accessed via `runtime.context.phone_number` in nodes
  - LLM only sees/generates game messages

### Intelligent Evaluation
- ‚úÖ **No random chance** (unlike pattern-matching version)
- ‚úÖ **Kimi K2 evaluates** each message against level defenses
- ‚úÖ **Structured output** guarantees JSON schema compliance
- ‚úÖ **Contextual responses** generated by Kimi K2

### State Management
- ‚úÖ **Postgres checkpointer** for LangGraph conversation state
- ‚úÖ **Redis** for user game progress
- ‚úÖ **Thread-based persistence** (one thread per phone number)

## API Endpoints

### `/ai/message` - AI-Powered Game
```bash
curl -X POST "http://localhost:8080/ai/message?phone_number=test_user&message=Hello%20friend"
```

Response:
```json
{
  "status": "success",
  "level": 1,
  "won_level": false,
  "won_game": false,
  "response": "Nice try! Keep going! üí™",
  "workflow_step": "message_sent"
}
```

### `/test/message` - Pattern-Matching Game (Original)
Still available for comparison.

## Dependencies Added

```
langgraph==0.6.10
groq==0.32.0
langchain-core==0.3.78
langchain-groq==0.3.8
langgraph-checkpoint-postgres==2.0.8
psycopg2-binary==2.9.9
```

## Configuration

### Environment Variables

```bash
# Groq API (for Kimi K2)
GROQ_API_KEY=<your_groq_api_key>  # Get from 1Password: op://Employee/Puffin04 Groq/password

# Postgres (for LangGraph checkpointer)
POSTGRES_URI=postgresql://user:pass@host:5432/dbname
```

### For Local Development

1. **Install dependencies**:
```bash
pip install -r requirements.txt
```

2. **Set up Postgres** (for checkpointer):
```bash
# Using Docker
docker run -d \
  --name postgres-langgraph \
  -e POSTGRES_USER=indaba \
  -e POSTGRES_PASSWORD=indaba \
  -e POSTGRES_DB=indaba_game \
  -p 5432:5432 \
  postgres:15

# Set POSTGRES_URI
export POSTGRES_URI="postgresql://indaba:indaba@localhost:5432/indaba_game"
```

3. **Set Groq API key**:
```bash
# Get from 1Password
export GROQ_API_KEY="<key_from_1password>"
```

4. **Run application**:
```bash
uvicorn app.main:app --reload --port 8080
```

5. **Test**:
```bash
./test_ai_game.sh
```

## Deployment Steps

### 1. Add Groq API Key to GCP Secret Manager

```bash
# Get key from 1Password: op://Employee/Puffin04 Groq/password
# Note: Remove any newlines from the end of the key

echo -n '<your_groq_api_key>' | gcloud secrets versions add groq-api-key --data-file=- --project=jem-it-indaba-2025
```

### 2. Update Pulumi Infrastructure

Add to `infra/__main__.py`:

```python
# Create Groq API key secret
groq_secret = gcp.secretmanager.Secret(
    "groq-api-key",
    secret_id="groq-api-key",
    replication=gcp.secretmanager.SecretReplicationArgs(
        auto=gcp.secretmanager.SecretReplicationAutoArgs(),
    ),
)

# Add Cloud SQL Postgres instance
postgres_instance = gcp.sql.DatabaseInstance(
    "game-postgres",
    name="indaba-game-postgres",
    database_version="POSTGRES_15",
    region=region,
    settings=gcp.sql.DatabaseInstanceSettingsArgs(
        tier="db-f1-micro",
        disk_size=10,
    )
)

# Add to Cloud Run environment variables
gcp.cloudrunv2.ServiceTemplateContainerEnvArgs(
    name="GROQ_API_KEY",
    value_source=gcp.cloudrunv2.ServiceTemplateContainerEnvValueSourceArgs(
        secret_key_ref=gcp.cloudrunv2.ServiceTemplateContainerEnvValueSourceSecretKeyRefArgs(
            secret=groq_secret.secret_id,
            version="latest",
        ),
    ),
),
gcp.cloudrunv2.ServiceTemplateContainerEnvArgs(
    name="POSTGRES_URI",
    value=postgres_instance.connection_name.apply(
        lambda conn: f"postgresql://user:pass@/dbname?host=/cloudsql/{conn}"
    ),
),
```

### 3. Deploy with Cloud Build

```bash
gcloud builds submit --config cloudbuild.yaml --project=jem-it-indaba-2025
```

### 4. Test Deployed Endpoint

```bash
# Run test script against deployed endpoint
./test_ai_game.sh
```

## Comparison: Pattern-Matching vs AI-Powered

| Aspect | Pattern-Matching (`/test/message`) | AI-Powered (`/ai/message`) |
|--------|-------------------------------------|----------------------------|
| **Evaluation** | Regex patterns | Kimi K2 intelligent judgment |
| **Responses** | Random from predefined list | Kimi K2 generated, contextual |
| **Determinism** | 100% deterministic (but with 15% random win chance) | AI-based (more flexible, no random chance) |
| **State Storage** | Redis only | Postgres (LangGraph) + Redis |
| **Phone Security** | In function params | Secured in Runtime context |
| **Cost** | Free | ~$1/1M tokens (Groq pricing) |
| **Flexibility** | Fixed patterns | Adapts to creative bypasses |

## Testing

### Local Testing

```bash
# Test AI endpoint locally
curl -X POST "http://localhost:8080/ai/message?phone_number=test_user&message=Hello%20friend"

# Test pattern-matching endpoint
curl -X POST "http://localhost:8080/test/message?phone_number=test_user&message=Hello%20friend"

# Compare responses
```

### Automated Testing

```bash
# AI game test
./test_ai_game.sh

# Pattern-matching test
./test_levels.sh
```

## Troubleshooting

### "AI Game not available" Error

**Cause**: Missing dependencies

**Fix**:
```bash
pip install langgraph==0.6.10 groq==0.32.0 langchain-core==0.3.78 langchain-groq==0.3.8 langgraph-checkpoint-postgres==2.0.8
```

### "Postgres checkpointer not initialized" Error

**Cause**: Missing or invalid POSTGRES_URI

**Fix**:
```bash
# Set POSTGRES_URI environment variable
export POSTGRES_URI="postgresql://user:pass@localhost:5432/indaba_game"

# Or for Cloud SQL (in production)
export POSTGRES_URI="postgresql://user:pass@/dbname?host=/cloudsql/project:region:instance"
```

### Groq API Errors

**Cause**: Invalid or missing GROQ_API_KEY

**Fix**:
```bash
# Get key from 1Password (remove trailing newlines!)
export GROQ_API_KEY="<key_without_newlines>"
```

## Next Steps

1. ‚úÖ **Code Complete**: All files created and integrated
2. ‚è≥ **Deploy Infrastructure**: Update Pulumi with Postgres + Groq secret
3. ‚è≥ **Deploy Application**: `gcloud builds submit`
4. ‚è≥ **Test**: Run `./test_ai_game.sh` against deployed endpoint
5. ‚è≥ **Compare**: Test both endpoints side-by-side
6. ‚è≥ **Monitor**: Check Groq usage and costs

## Files Created

- `app/ai_game/` - Complete AI game module
- `test_ai_game.sh` - Test script
- Updated `app/main.py` - Added `/ai/message` endpoint
- Updated `app/config.py` - Added Groq/Postgres config
- Updated `requirements.txt` - Added LangGraph/Groq dependencies
- `AI_GAME_README.md` - This file

## Notes

- **Both games coexist**: Pattern-matching and AI-powered run independently
- **Phone security**: LLM never sees phone numbers (secured in Runtime context)
- **Structured output**: Guaranteed JSON schema compliance via Groq
- **Production-ready**: Follows proven Puffin architecture pattern
- **Cost-effective**: Groq's Kimi K2 is ~$1/1M tokens (very affordable)

## Support

For questions or issues:
1. Check this README
2. Review Puffin project: `jem_mobile/whatsapp_chatbot`
3. Check LangGraph docs: https://langchain-ai.github.io/langgraph/
4. Check Groq docs: https://console.groq.com/docs
